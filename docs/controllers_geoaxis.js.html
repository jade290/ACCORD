

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: controllers/geoaxis.js | React Template</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/style.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="">
        
            <a href="https://devcorps-dev.dev.east.paas.nga.mil" rel="noopener noreferrer" target="_blank">
                <img src="img/DevCorpsLogo.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">React Template</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-App.html">App</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:App_sub"></div></li><li><a href="module-components_ClassificationBanner.html">components/ClassificationBanner</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:components/ClassificationBanner_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-components_ClassificationBanner.html#~ClassificationBanner">ClassificationBanner</a></li></ul></div></li><li><a href="module-components_Footer.html">components/Footer</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:components/Footer_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-components_Footer.html#~Footer">Footer</a></li></ul></div></li><li><a href="module-components_Navbar.html">components/Navbar</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:components/Navbar_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-components_Navbar.html#~Navbar">Navbar</a></li></ul></div></li><li><a href="module-geoaxis.html">geoaxis</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:geoaxis_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-geoaxis.html#~doesValidTokenExist">doesValidTokenExist</a></li><li><a href="module-geoaxis.html#~getRedirectUrl">getRedirectUrl</a></li><li><a href="module-geoaxis.html#~getToken">getToken</a></li><li><a href="module-geoaxis.html#~getUserInfo">getUserInfo</a></li><li><a href="module-geoaxis.html#~loggedIn">loggedIn</a></li><li><a href="module-geoaxis.html#~parseCodeFromURL">parseCodeFromURL</a></li><li><a href="module-geoaxis.html#~removeToken">removeToken</a></li><li><a href="module-geoaxis.html#~storeToken">storeToken</a></li><li><a href="module-geoaxis.html#~tradeCodeForToken">tradeCodeForToken</a></li></ul></div></li><li><a href="module-index.html">index</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:index_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-index.html#~App">App</a></li><li><a href="module-index.html#~AsyncLogin">AsyncLogin</a></li><li><a href="module-index.html#~Login">Login</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-index.html#~renderApp">renderApp</a></li></ul></div></li><li><a href="module-views.html">views</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:views_sub"></div></li><li><a href="module-views_Home.html">views/Home</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:views/Home_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-views_Home.html#~Home">Home</a></li></ul></div></li><li><a href="module-views_Login.html">views/Login</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:views/Login_sub"></div></li><li><a href="module-views_NotFound.html">views/NotFound</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:views/NotFound_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-views_NotFound.html#~NotFound">NotFound</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="module-App-App.html">App</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:App~App_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-App-App.html#getUserInfo">getUserInfo</a></li><li><a href="module-App-App.html#renderRoute">renderRoute</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-App-App.html#componentDidMount">componentDidMount</a></li><li><a href="module-App-App.html#render">render</a></li></ul></div></li><li><a href="module-views_Login-Login.html">Login</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:views/Login~Login_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="module-views_Login-Login.html#renderAlert">renderAlert</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="module-views_Login-Login.html#componentDidMount">componentDidMount</a></li><li><a href="module-views_Login-Login.html#getRedirectUrl">getRedirectUrl</a></li><li><a href="module-views_Login-Login.html#render">render</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3><a href="global.html">Global</a></h3></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* @module geoaxis
*
* @author Rachel Choate &lt;Rachel.J.Choate@nga.mil>
*/

import request from 'request-promise';
import ls from 'local-storage';
import CONFIG from '../config/config.json';

const gx = {
    loggedIn,
    logout: removeToken,
    getRedirectUrl,
    getUserInfo,
    getToken,
};

/**
* Checks for the existance
* and validity of a geoaxis authentication
* token in local storage.  On not finding
* a valid token, checks for the existance
* of an auth code as a parameter in the
* window's URL.  If a code is found,
* the code is passed to the SSO API in
* exchange for an authentication token.
* Stores authentication tokens in local
* storage.  Returns true if a valid token
* exists at the end of the workflow, and
* false if the user needs to authenticate.
*/
async function loggedIn() {
    /** check local storage for valid auth token */
    const hasValidToken = await doesValidTokenExist();
    if (hasValidToken) return true;
    /** check URL for auth code */
    const authCode = await parseCodeFromURL();
    if (!authCode) return false;
    /** trade the code for a token */
    const token = await tradeCodeForToken(authCode);
    if (!token) return false;
    /** save token to local storage */
    storeToken(token);
    const user = await getUserInfo();
    if (!user) return false;
    return true;
}

/**
* check for and validate token from localstorage
*/
async function doesValidTokenExist() {
    const token = ls.get('gxToken');
    if (typeof (token) === 'string') {
        const valid = await getUserInfo();
        if (!valid) return false;
        return valid;
    }
    return false;
}

/**
* store token in localstorage
*/
function storeToken(token) {
    ls.set('gxToken', token);
}

/**
* redirect the browser window to geoaxis login page
*/
async function getRedirectUrl() {
    const url = await request({
        url: `${CONFIG.apiUrl}/auth/redirect?redirectUrl=https://${window.location.hostname}`,
        followRedirect: false,
        resolveWithFullResponse: true,
    }).then((resp) => {
        const response = JSON.parse(resp.body);
        return response.redirectUrl;
    }, err =>
        null);
    return url;
}

/**
* check for and parse and authentication code from the url
*/
function parseCodeFromURL() {
    let url = window.location.href;
    url = url.split('?code=');
    if (url.length > 1) return url[1];
    return false;
}

/**
* trade your auth code for a shiny auth token
*/
async function tradeCodeForToken(code) {
    let token = await request({
        url: `${CONFIG.apiUrl}/auth/token?code=${code}&amp;redirectUrl=https://${window.location.hostname}`,
    }).then((resp) => {
        token = JSON.parse(resp);
        if (token.access_token) {
            token = token.access_token;
            return token;
        }
        return false;
    }, err =>
        // console.error(err);
        false);

    return token;
}

/**
* returns the gx token from localstorage
*/
function getToken() {
    return ls.get('gxToken');
}

/**
* deletes gx token from localstorage
*/
function removeToken() {
    return ls.remove('gxToken');
}

/**
* Uses a valid authentication
* token to retrieve the user information
* of the logged in user from the SSO API's
* /userInfo endpoint.  Generally consists
* of an email address, unique user ID,
* and a First and Last name, badly parsed
* from the user's email address (a
* contractor will generally have .ctr
* appended to his last name).
*/
async function getUserInfo() {
    const userInfo = await request({
        url: `${CONFIG.apiUrl}/auth/userinfo`,
        headers: { Authorization: `Bearer ${ls.get('gxToken')}` },
        method: 'GET',
    }).then((resp) => {
        let user = {};
        try {
            user = JSON.parse(resp);
        } catch (e) {
            user = resp;
        }
        return user;
    }, (error) => {
        removeToken();
        return false;
    });

    ls.set('gxUser', userInfo);

    return userInfo;
}

export default gx;
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="img/DevCorpsLogo.png" style="">
    <div class="footer-text">NGA DevCorps</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
